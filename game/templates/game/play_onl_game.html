{% load static %}
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Phòng {{room.code}} | Trò chơi Caro 3x3</title>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center font-['Roboto']">

    <div class="w-full max-w-4xl flex flex-col items-center px-4">

        <!-- Player / Room Info -->
        <div class="flex flex-wrap justify-between w-full max-w-2xl mb-6">
            <p class="text-gray-800 font-medium">{{name}} (Bạn)</p>
            <p class="text-gray-800 font-medium">Phòng: {{ room.code }}</p>
            <p id="opponent-txt" class="text-gray-600">Đang chờ người chơi khác...</p>
        </div>

        <!-- Game Board -->
        <div class="grid grid-cols-3 grid-rows-3 gap-0 w-80 h-80 border border-gray-600 rounded-lg overflow-hidden">
            {% for i in "012345678" %}
            <div boxIndex="{{i}}" player="" class="box flex justify-center items-center cursor-pointer border border-gray-600"></div>
            {% endfor %}
        </div>

        <!-- Turn Info -->
        <div class="mt-6 w-full text-center">
            <p id="turn" class="text-gray-700 text-lg font-medium"></p>
        </div>
    </div>

    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        let board = {0:'',1:'',2:'',3:'',4:'',5:'',6:'',7:'',8:''};
        let myTurn = false;
        let playerLetter = "";
        const opponentTxtElm = document.getElementById("opponent-txt");
        const turnElm = document.getElementById("turn");
        const boxes = document.getElementsByClassName("box");

        Array.from(boxes).forEach((elm, i) => {
            elm.addEventListener("click", () => {
                if (myTurn && !elm.innerHTML && !elm.getAttribute("player")) {
                    board[i] = playerLetter;
                    ws.send(JSON.stringify({ event: 'boardData_send', board: board }));
                    addPlayerLetter(elm);
                    myTurn = false;
                }
            });
        });

        function addPlayerLetter(element, player = playerLetter) {
            const imgSrc = player === "X"
                ? "{% static 'game/x.png' %}"
                : "{% static 'game/o.png' %}";

            element.innerHTML = `
                <img src="${imgSrc}"
                     class="w-16 h-16 transform scale-0 opacity-0 transition-all duration-300 ease-out" />
            `;
            element.setAttribute("player", player);

            setTimeout(() => {
                element.children[0].classList.add("scale-100","opacity-100");
            }, 1);
        }

        function resetBoard() {
            Array.from(boxes).forEach(elm => {
                elm.innerHTML = '';
                elm.setAttribute("player", "");
            });
        }

        function updateBoard(boardData) {
            Array.from(boxes).forEach((elm, i) => {
                if (boardData[i] !== "" && !elm.getAttribute("player")) {
                    addPlayerLetter(elm, boardData[i]);
                }
            });
        }

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        const wsUrl = protocol + '//' + host + '/ws/game/{{ room.code }}/';
        const ws = new WebSocket(wsUrl);

        ws.onopen = () => console.log('WebSocket connected!');

        ws.onmessage = e => {
            const data = JSON.parse(e.data);

            if (data.event === "show_error") {
                Swal.fire({ icon: 'error', title: data.error }).then(() => window.location = '/');
            }

            else if (data.event === "game_start") {
                board = data.board;
                myTurn = data.myTurn;
                playerLetter = data.myTurn ? "X" : "O";

                resetBoard();
                turnElm.textContent = data.myTurn ? "Lượt của bạn" : "Lượt của đối thủ";
                opponentTxtElm.textContent = "Đối thủ đã tham gia!";

                setTimeout(() => Swal.close(), 500);
            }

            else if (data.event === "boardData_send") {
                board = data.board;
                myTurn = data.myTurn;

                updateBoard(board);
                turnElm.textContent = data.myTurn ? "Lượt của bạn" : "Lượt của đối thủ";
            }

            else if (data.event === "won" || data.event === "draw" || data.event === "opponent_left") {
                board = data.board;
                myTurn = data.myTurn;

                updateBoard(board);

                if (data.event === "won") {
                    turnElm.textContent = (data.winner == playerLetter) ? "Bạn thắng!" : "Bạn thua!";
                }
                else if (data.event === "draw") {
                    turnElm.textContent = "Hòa!";
                }
                else {
                    opponentTxtElm.textContent = "Đối thủ đã rời phòng.";
                }

                setTimeout(() => {
                    Swal.fire({
                        icon: data.event === "won"
                            ? (data.winner == playerLetter ? 'success' : 'error')
                            : data.event === "draw" ? 'info' : 'info',
                        title: data.event === "won"
                            ? (data.winner == playerLetter ? 'Bạn thắng!' : 'Bạn thua!')
                            : data.event === "draw" ? 'Hòa!' : 'Đối thủ đã rời phòng',
                        confirmButtonText: "Chơi lại"
                    }).then(() => ws.send(JSON.stringify({ event: 'restart' })))
                }, 400);
            }
        };
    </script>
</body>
</html>
